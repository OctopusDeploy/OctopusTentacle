AWSTemplateFormatVersion: 2010-09-09
Parameters:
  InstanceKeyPairName:
    Type: String
  InstanceAmi:
    Type: String
  InstanceSecurityGroupId:
    Type: String
  InstanceSubnetId:
    Type: String
  InstanceTypeParameter:
    Type: String
    Default: t2.medium
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t3.large
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - cg1.4xlarge
    Description: Enter instance size. Default is m3.medium.
Resources:
  PublishAgent:
    Type: 'AWS::EC2::Instance'
    Properties:
      SubnetId: !Ref InstanceSubnetId
      ImageId: !Ref InstanceAmi
      InstanceType:
        Ref: InstanceTypeParameter
      KeyName: !Ref InstanceKeyPairName
      SecurityGroupIds:
      - Ref: InstanceSecurityGroupId
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeSize: 50
      Tags:
        -
          Key: Appplication
          Value: Linux Tentacle
        -
          Key: Domain
          Value: None
        -
          Key: Environment
          Value: Production
        -
          Key: LifeTime
          Value: Transient
        -
          Key: Name
          Value: Linux Tentacle publish agent
        -
          Key: OS
          Value: Linux
        -
          Key: OwnerContact
          Value: "#{Deployer Contact}"
        -
          Key: Source
          Value: CloudForation Script in Octopus Deploy
        -
          Key: scheduler:ec2-startstop
          Value: false
      UserData:
        Fn::Base64: |
          #!/bin/bash
          exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
          sudo apt-get update && apt-get install -y gnupg1 wget

          sudo echo "deb http://repo.aptly.info/ squeeze main" > /etc/apt/sources.list.d/aptly.list
          wget -qO - https://www.aptly.info/pubkey.txt | apt-key add -

          sudo apt-get update && apt-get install -y \
            gpgv1 \
            aptly \
            awscli \
            createrepo \
            && rm -rf /var/lib/apt/lists/*

          # Install and configure Tentacle
          serverUrl="#{Octopus.Web.ServerUri}"
          thumbprint="#{Publisher.Tentacle.OctopusThumbprint}"
          apiKey="#{Publisher.Tentacle.OctopusApiKey}"
          name="#{Publisher.Tentacle.Name}"
          environment="#{Octopus.Environment.Name}"
          role="#{Publisher.Tentacle.Role}"
          space="#{Octopus.Space.Name}"
          machinePolicy="#{Publisher.Tentacle.MachinePolicy}"
          configFilePath="/etc/octopus/default/tentacle-default.config"
          applicationPath="/home/Octopus/Applications/"

          tentacleArchiveName=tentacle-#{Octopus.Action.Package.PackageVersion}-linux_x64.tar.gz
          curl https://download.octopusdeploy.com/#{S3:LinuxTentacleDownloadPath}$tentacleArchiveName --output $tentacleArchiveName

          mkdir /opt/octopus
          tar xvzf $tentacleArchiveName -C /opt/octopus

          sudo chmod +x /opt/octopus/tentacle/Tentacle
          sudo cat > /etc/systemd/system/tentacle.service << EOM
          [Unit]
          Description=Octopus Tentacle Server
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/etc/octopus/default/
          ExecStart=/opt/octopus/tentacle/Tentacle run --noninteractive
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOM

          sudo chmod 644 /etc/systemd/system/tentacle.service

          sudo /opt/octopus/tentacle/Tentacle create-instance --config "$configFilePath"
          sudo /opt/octopus/tentacle/Tentacle new-certificate --if-blank
          sudo /opt/octopus/tentacle/Tentacle configure --reset-trust --app "$applicationPath"
          sudo /opt/octopus/tentacle/Tentacle configure --port 10933 --noListen False
          sudo /opt/octopus/tentacle/Tentacle configure --trust $thumbprint
          echo "Registering the Tentacle $name with server $serverUrl in environment $environment with role $role"
          sudo /opt/octopus/tentacle/Tentacle register-with --server "$serverUrl" --apiKey "$apiKey" --name "$name" --env "$environment" --role "$role" --space "$space" --policy "$machinePolicy"
          sudo systemctl start tentacle
Outputs:
  InstanceID:
    Description: The Instance ID
    Value: !Ref PublishAgent